import i from"@typo3/backend/ajax-data-handler.js";import o from"@typo3/backend/context-menu-actions.js";import s from"./custom-delete-handler.js";import"@typo3/backend/modal.js";import"@typo3/backend/enum/severity.js";import"@typo3/backend/severity.js";import"@typo3/core/ajax/ajax-request.js";class h{originalContextMenuDelete;originalAjaxDataHandlerProcess;init(){this.patchContextMenuActions(),this.patchAjaxDataHandler(),this.interceptModalTriggers()}patchContextMenuActions(){this.originalContextMenuDelete=o.deleteRecord.bind(o),o.deleteRecord=async(e,r,t={})=>{if(e!=="pages"){this.originalContextMenuDelete(e,r,t);return}if(!await s.checkAndShowModal(e,r,t))return;const c={component:"contextmenu",action:"delete",table:e,uid:Number.parseInt(r,10)};await this.originalAjaxDataHandlerProcess(`cmd[${e}][${r}][delete]=1`,c),o.refreshPageTree();const n=top.TYPO3?.Backend?.ContentContainer?.get();n&&o.triggerRefresh(n.location.href)}}patchAjaxDataHandler(){this.originalAjaxDataHandlerProcess=i.process.bind(i),i.process=(e,r)=>{const t=this.extractPageUid(e);return t?this.handleDirectPageDelete(t,e,r??{}):this.originalAjaxDataHandlerProcess(e,r)}}interceptModalTriggers(){document.addEventListener("click",async e=>{const t=e.target.closest(".t3js-modal-trigger");if(!t)return;const a=t.dataset.uri||t.dataset.href;if(!a)return;const n=decodeURIComponent(a).match(/cmd\[pages\]\[(\d+)\]\[delete\]=1/);if(!n)return;e.preventDefault(),e.stopImmediatePropagation();const d=n[1];try{await s.checkAndShowModal("pages",d)&&(window.location.href=a)}catch{window.location.href=a}},!0)}async handleDirectPageDelete(e,r,t){try{return await s.checkAndShowModal("pages",e,t)?this.originalAjaxDataHandlerProcess(r,t):{hasErrors:!1,messages:[]}}catch{return this.originalAjaxDataHandlerProcess(r,t)}}extractPageUid(e){if(typeof e=="string"){const a=e.match(/cmd\[pages\]\[(\d+)\]\[delete\]=1/);return a?a[1]:null}const r=e.cmd?.pages;if(!r)return null;const[t]=Object.keys(r);return t&&r[t]?.delete?t:null}}const g=new h;g.init();export{g as default};
