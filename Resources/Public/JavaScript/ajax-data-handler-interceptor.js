import h from"@typo3/backend/ajax-data-handler.js";import i from"@typo3/backend/context-menu-actions.js";import l from"./custom-delete-handler.js";import"@typo3/backend/modal.js";import"@typo3/backend/enum/severity.js";import"@typo3/backend/severity.js";import"@typo3/core/ajax/ajax-request.js";class c{static PAGE_DELETE_PATTERN=/cmd\[pages\]\[(\d+)\]\[delete\]=1/;originalContextMenuDelete;originalAjaxDataHandlerProcess;init(){this.patchContextMenuActions(),this.patchAjaxDataHandler(),this.interceptModalTriggers()}patchContextMenuActions(){this.originalContextMenuDelete=i.deleteRecord.bind(i),i.deleteRecord=async(t,r,e={})=>{if(t!=="pages"){this.originalContextMenuDelete(t,r,e);return}if(!await l.checkAndShowModal(t,r,e))return;const a={component:"contextmenu",action:"delete",table:t,uid:Number.parseInt(r,10)};await this.originalAjaxDataHandlerProcess(`cmd[${t}][${r}][delete]=1`,a),i.refreshPageTree();const n=top.TYPO3?.Backend?.ContentContainer?.get();n&&i.triggerRefresh(n.location.href)}}patchAjaxDataHandler(){this.originalAjaxDataHandlerProcess=h.process.bind(h),h.process=(t,r)=>{const e=this.extractPageUid(t);return e?this.handleDirectPageDelete(e,t,r??{}):this.originalAjaxDataHandlerProcess(t,r)}}interceptModalTriggers(){this.addModalTriggerListener(document,window),this.watchForIframes()}watchForIframes(){const t=e=>{try{const o=e.contentDocument,a=e.contentWindow;o&&a&&(this.addModalTriggerListener(o,a),this.addRecordDeleteListener(o,a))}catch{}};new MutationObserver(e=>{for(const o of e)for(const a of o.addedNodes)a instanceof HTMLIFrameElement&&(a.addEventListener("load",()=>t(a)),a.contentDocument?.readyState==="complete"&&t(a)),a instanceof HTMLElement&&a.querySelectorAll("iframe").forEach(s=>{s.addEventListener("load",()=>t(s)),s.contentDocument?.readyState==="complete"&&t(s)})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll("iframe").forEach(e=>{e.addEventListener("load",()=>t(e)),e.contentDocument?.readyState==="complete"&&t(e)})}addModalTriggerListener(t,r){t.addEventListener("click",async e=>{const a=e.target.closest(".t3js-modal-trigger");if(!a)return;const n=a.dataset.uri||a.dataset.href;if(!n)return;const d=decodeURIComponent(n).match(c.PAGE_DELETE_PATTERN);if(!d)return;e.preventDefault(),e.stopImmediatePropagation();const u=d[1];try{await l.checkAndShowModal("pages",u)&&(r.location.href=n)}catch{r.location.href=n}},!0)}addRecordDeleteListener(t,r){t.addEventListener("click",async e=>{const a=e.target.closest(".t3js-record-delete");if(!a)return;const n=a.dataset.params;if(!n)return;const s=n.match(c.PAGE_DELETE_PATTERN);if(!s)return;e.preventDefault(),e.stopImmediatePropagation();const d=s[1];try{await l.checkAndShowModal("pages",d)&&(await this.originalAjaxDataHandlerProcess(n),i.refreshPageTree(),r.location.reload())}catch{await this.originalAjaxDataHandlerProcess(n),i.refreshPageTree(),r.location.reload()}},!0)}async handleDirectPageDelete(t,r,e){try{return await l.checkAndShowModal("pages",t,e)?this.originalAjaxDataHandlerProcess(r,e):{hasErrors:!1,messages:[]}}catch{return this.originalAjaxDataHandlerProcess(r,e)}}extractPageUid(t){if(typeof t=="string"){const o=t.match(c.PAGE_DELETE_PATTERN);return o?o[1]:null}const r=t.cmd?.pages;if(!r)return null;const[e]=Object.keys(r);return e&&r[e]?.delete?e:null}}const g=new c;g.init();export{g as default};
