import d from"@typo3/backend/ajax-data-handler.js";import i from"@typo3/backend/context-menu-actions.js";import l from"./custom-delete-handler.js";import"@typo3/backend/modal.js";import"@typo3/backend/enum/severity.js";import"@typo3/backend/severity.js";import"@typo3/core/ajax/ajax-request.js";class c{static PAGE_DELETE_PATTERN=/cmd\[pages\]\[(\d+)\]\[delete\]=1/;originalContextMenuDelete;originalAjaxDataHandlerProcess;init(){this.patchContextMenuActions(),this.patchAjaxDataHandler(),this.interceptModalTriggers()}patchContextMenuActions(){this.originalContextMenuDelete=i.deleteRecord.bind(i),i.deleteRecord=async(t,r,e={})=>{if(t!=="pages"){this.originalContextMenuDelete(t,r,e);return}if(!await l.checkAndShowModal(t,r,e))return;const o={component:"contextmenu",action:"delete",table:t,uid:Number.parseInt(r,10)};await this.originalAjaxDataHandlerProcess(`cmd[${t}][${r}][delete]=1`,o),i.refreshPageTree();const a=top.TYPO3?.Backend?.ContentContainer?.get();a&&i.triggerRefresh(a.location.href)}}patchAjaxDataHandler(){this.originalAjaxDataHandlerProcess=d.process.bind(d),d.process=(t,r)=>{const e=this.extractPageUid(t);return e?this.handleDirectPageDelete(e,t,r??{}):this.originalAjaxDataHandlerProcess(t,r)}}interceptModalTriggers(){this.addModalTriggerListener(document,window),this.watchForIframes()}watchForIframes(){const t=e=>{try{const n=e.contentDocument,o=e.contentWindow;n&&o&&this.addModalTriggerListener(n,o)}catch{}};new MutationObserver(e=>{for(const n of e)for(const o of n.addedNodes)o instanceof HTMLIFrameElement&&(o.addEventListener("load",()=>t(o)),o.contentDocument?.readyState==="complete"&&t(o)),o instanceof HTMLElement&&o.querySelectorAll("iframe").forEach(s=>{s.addEventListener("load",()=>t(s)),s.contentDocument?.readyState==="complete"&&t(s)})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll("iframe").forEach(e=>{e.addEventListener("load",()=>t(e)),e.contentDocument?.readyState==="complete"&&t(e)})}addModalTriggerListener(t,r){t.addEventListener("click",async e=>{const o=e.target.closest(".t3js-modal-trigger");if(!o)return;const a=o.dataset.uri||o.dataset.href;if(!a)return;const h=decodeURIComponent(a).match(c.PAGE_DELETE_PATTERN);if(!h)return;e.preventDefault(),e.stopImmediatePropagation();const u=h[1];try{await l.checkAndShowModal("pages",u)&&(r.location.href=a)}catch{r.location.href=a}},!0)}async handleDirectPageDelete(t,r,e){try{return await l.checkAndShowModal("pages",t,e)?this.originalAjaxDataHandlerProcess(r,e):{hasErrors:!1,messages:[]}}catch{return this.originalAjaxDataHandlerProcess(r,e)}}extractPageUid(t){if(typeof t=="string"){const n=t.match(c.PAGE_DELETE_PATTERN);return n?n[1]:null}const r=t.cmd?.pages;if(!r)return null;const[e]=Object.keys(r);return e&&r[e]?.delete?e:null}}const g=new c;g.init();export{g as default};
