import s from"@typo3/backend/ajax-data-handler.js";import o from"@typo3/backend/context-menu-actions.js";import c from"./custom-delete-handler.js";import"@typo3/backend/modal.js";import"@typo3/backend/enum/severity.js";import"@typo3/backend/severity.js";import"@typo3/core/ajax/ajax-request.js";class i{static PAGE_DELETE_PATTERN=/cmd\[pages\]\[(\d+)\]\[delete\]=1/;originalContextMenuDelete;originalAjaxDataHandlerProcess;init(){this.patchContextMenuActions(),this.patchAjaxDataHandler(),this.interceptModalTriggers()}patchContextMenuActions(){this.originalContextMenuDelete=o.deleteRecord.bind(o),o.deleteRecord=async(e,r,t={})=>{if(e!=="pages"){this.originalContextMenuDelete(e,r,t);return}if(!await c.checkAndShowModal(e,r,t))return;const d={component:"contextmenu",action:"delete",table:e,uid:Number.parseInt(r,10)};await this.originalAjaxDataHandlerProcess(`cmd[${e}][${r}][delete]=1`,d),o.refreshPageTree();const n=top.TYPO3?.Backend?.ContentContainer?.get();n&&o.triggerRefresh(n.location.href)}}patchAjaxDataHandler(){this.originalAjaxDataHandlerProcess=s.process.bind(s),s.process=(e,r)=>{const t=this.extractPageUid(e);return t?this.handleDirectPageDelete(t,e,r??{}):this.originalAjaxDataHandlerProcess(e,r)}}interceptModalTriggers(){document.addEventListener("click",async e=>{const t=e.target.closest(".t3js-modal-trigger");if(!t)return;const a=t.dataset.uri||t.dataset.href;if(!a)return;const n=decodeURIComponent(a).match(i.PAGE_DELETE_PATTERN);if(!n)return;e.preventDefault(),e.stopImmediatePropagation();const l=n[1];try{await c.checkAndShowModal("pages",l)&&(window.location.href=a)}catch{window.location.href=a}},!0)}async handleDirectPageDelete(e,r,t){try{return await c.checkAndShowModal("pages",e,t)?this.originalAjaxDataHandlerProcess(r,t):{hasErrors:!1,messages:[]}}catch{return this.originalAjaxDataHandlerProcess(r,t)}}extractPageUid(e){if(typeof e=="string"){const a=e.match(i.PAGE_DELETE_PATTERN);return a?a[1]:null}const r=e.cmd?.pages;if(!r)return null;const[t]=Object.keys(r);return t&&r[t]?.delete?t:null}}const g=new i;g.init();export{g as default};
